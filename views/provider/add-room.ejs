<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Đăng thông tin phòng</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #fafafa;
      }
      .form-container {
        background-color: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .btn-success {
        background-color: #28a745;
      }
    </style>
  </head>

  <body class="container py-5">
    <div class="form-container mx-auto col-md-8">
      <h2 class="text-center mb-4">Đăng thông tin phòng</h2>

      <!-- Hiển thị thông báo lỗi -->
      <% if (error) { %>
      <div class="alert alert-danger"><%- error %></div>
      <% } %>

      <!-- Hiển thị thông báo thành công -->
      <% if (success) { %>
      <div class="alert alert-success text-center"><%= success %></div>
      <% } %>

      <form
        method="POST"
        action="/provider/add-room"
        enctype="multipart/form-data"
        id="addRoomForm"
      >
        <!-- Tên phòng -->
        <div class="mb-3">
          <label for="roomName" class="form-label">Tên phòng</label>
          <input
            type="text"
            class="form-control"
            name="roomName"
            id="roomName"
            placeholder="Nhập tên phòng"
            required
          />
        </div>

        <!-- Địa chỉ -->
        <div class="mb-3">
          <label class="form-label">Địa chỉ phòng</label>

          <div class="row">
            <div class="col-md-4">
              <label for="city" class="form-label">Thành phố</label>
              <select id="city" class="form-select" required>
                <option value="">-- Chọn thành phố --</option>
                <% const cities = [...new Set(addresses.map(a => a.city))]; %>
                <% cities.forEach(city => { %>
                <option value="<%= city %>"><%= city %></option>
                <% }) %>
              </select>
            </div>

            <div class="col-md-4">
              <label for="district" class="form-label">Quận/Huyện</label>
              <select id="district" class="form-select" required disabled>
                <option value="">-- Chọn quận/huyện --</option>
              </select>
            </div>

            <div class="col-md-4">
              <label for="ward" class="form-label">Phường/Xã</label>
              <select id="ward" class="form-select" required disabled>
                <option value="">-- Chọn phường/xã --</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <label for="customAddress" class="form-label"
              >Tên đường / Số nhà</label
            >
            <input
              type="text"
              class="form-control"
              id="customAddress"
              name="customAddress"
              placeholder="VD: 12 Nguyễn Trãi"
              required
            />
          </div>

          <!-- input ẩn để gửi về controller -->
          <input type="hidden" name="addressId" id="addressId" />
          <input type="hidden" name="fullAddress" id="fullAddress" />
        </div>

        <script>
          const addresses = <%- JSON.stringify(addresses) %>;
        </script>
        <script src="/javascript/addressDropdown.js"></script>

        <!-- Sức chứa -->
        <div class="mb-3">
          <label for="capacity" class="form-label">Sức chứa (người)</label>
          <input
            type="number"
            class="form-control"
            name="capacity"
            id="capacity"
            min="1"
            required
          />
        </div>

        <!-- Giá phòng -->
        <div class="mb-3">
          <label for="price" class="form-label">Giá phòng (VND)</label>
          <input
            type="number"
            class="form-control"
            name="price"
            id="price"
            min="1"
            required
          />
        </div>

        <!-- Tiện ích -->
        <div class="mb-3">
          <label for="amenities" class="form-label">Tiện ích</label>
          <input
            type="text"
            class="form-control"
            name="amenities"
            id="amenities"
            placeholder="Ví dụ: Wifi, Máy lạnh, TV"
            required
          />
        </div>

        <!-- Mô tả -->
        <div class="mb-3">
          <label for="description" class="form-label">Mô tả chi tiết</label>
          <textarea
            class="form-control"
            name="description"
            id="description"
            rows="4"
            placeholder="Mô tả đặc điểm phòng, không gian, tiện ích..."
            required
          ></textarea>
        </div>

        <!-- Ảnh phòng -->
        <div class="mb-3">
          <label for="images" class="form-label">Ảnh phòng</label>
          <input
            type="file"
            class="form-control"
            id="images"
            name="images"
            multiple
            accept=".jpg,.jpeg,.png"
            required
          />
        </div>

        <div class="text-center mt-4">
          <button type="submit" class="btn btn-success px-4">Đăng phòng</button>
          <a href="/provider/dashboard" class="btn btn-secondary ms-3 px-4"
            >Hủy</a
          >
        </div>
      </form>
    </div>

    <script>
      // ✅ Hộp thoại xác nhận khi bấm "Đăng phòng"
      document
        .getElementById("addRoomForm")
        .addEventListener("submit", function (e) {
          const confirmSubmit = confirm(
            "Bạn có chắc chắn muốn đăng thông tin phòng này?"
          );
          if (!confirmSubmit) {
            e.preventDefault(); // Hủy gửi form
            return;
          }

          // ✅ Kiểm tra dữ liệu cơ bản trước khi gửi
          const roomName = document.getElementById("roomName").value.trim();
          const price = parseFloat(document.getElementById("price").value);
          const capacity = parseInt(document.getElementById("capacity").value);
          const amenities = document.getElementById("amenities").value.trim();
          const description = document
            .getElementById("description")
            .value.trim();
          const image = document.getElementById("image").files[0];

          const roomNameRegex = /^[a-zA-ZÀ-ỹ0-9\s]+$/;
          let errors = [];

          if (!roomNameRegex.test(roomName)) {
            errors.push("Tên phòng không hợp lệ. Không chứa ký tự đặc biệt.");
          }

          if (isNaN(price) || price <= 0) {
            errors.push("Giá phòng phải là số > 0.");
          }

          if (isNaN(capacity) || capacity < 1) {
            errors.push("Sức chứa phải ≥ 1.");
          }

          if (!amenities) {
            errors.push("Vui lòng nhập tiện ích của phòng.");
          }

          if (!description) {
            errors.push("Vui lòng nhập mô tả chi tiết của phòng.");
          }

          if (!image) {
            errors.push("Vui lòng chọn ảnh phòng.");
          } else {
            const allowed = ["image/jpeg", "image/png", "image/jpg"];
            if (!allowed.includes(image.type)) {
              errors.push("Ảnh không đúng định dạng (.jpg, .jpeg, .png).");
            }
          }

          if (errors.length > 0) {
            e.preventDefault();
            alert(errors.join("\n"));
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
