<%- include('../partials/header') %>
<div class="container my-5">
  <!-- ===== THÔNG BÁO ===== -->
  <% if (error) { %>
  <div class="alert alert-danger text-center fw-bold"><%= error %></div>
  <% } %> <% if (success) { %>
  <div class="alert alert-success text-center fw-bold"><%= success %></div>
  <% } %>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Chi tiết đặt phòng</h3>
    <a href="/customer/history-dashboard" class="btn btn-outline-secondary"
      >Quay lại lịch sử</a
    >
  </div>
  <% if (!booking) { %>
  <p class="text-center text-muted">Không tìm thấy thông tin đặt phòng.</p>
  <% } else { const room = booking.Room || {}; const provider = room.Provider ||
  {}; const inv = booking.invoice || null; %>
  <!-- Thông tin phòng -->
  <div class="card shadow-sm p-4 mb-4">
    <div class="row">
      <div class="col-md-5">
        <img
          src="/uploads/imgrooms/<%= room.image ? room.image : 'default.png' %>"
          alt="<%= room.roomName ? room.roomName : 'Room' %>"
          class="img-fluid rounded shadow-sm"
          style="object-fit: cover; height: 250px; width: 100%"
        />
      </div>
      <div class="col-md-7">
        <h4 class="fw-bold mb-2">
          <%= room.roomName || 'Phòng không xác định' %>
        </h4>
        <p>
          <strong>Nhà cung cấp:</strong> <%= provider.providerName || 'Không rõ'
          %>
        </p>
        <p>
          <strong>Giá mỗi đêm:</strong> <%= room.price ?
          room.price.toLocaleString() : '0' %> VND
        </p>
        <p>
          <strong>Địa chỉ:</strong> <%- room.fullAddress || 'Chưa có thông tin'
          %>
        </p>
        <p>
          <strong>Mô tả:</strong> <%- room.description || 'Không có mô tả' %>
        </p>
      </div>
    </div>

    <!-- Thông tin đặt phòng -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="fw-bold mb-3">Thông tin đặt phòng</h5>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Mã đặt phòng:</strong> #<%= booking.bookingId %></p>
          <p><strong>Ngày đặt:</strong> <%= new Date(booking.bookingDate).toLocaleDateString('vi-VN') %></p>
          <p><strong>Nhận phòng:</strong> <%= new Date(booking.checkInDate).toLocaleDateString('vi-VN') %></p>
          <p><strong>Trả phòng:</strong> <%= new Date(booking.checkOutDate).toLocaleDateString('vi-VN') %></p>
        </div>
        <div class="col-md-6">
          <p><strong>Số khách:</strong> <%= booking.numberOfGuests %></p>
          <p><strong>Tổng tiền:</strong> <%= booking.totalAmount.toLocaleString() %> VND</p>
          <p><strong>Trạng thái:</strong> <%= booking.status %></p>
          <% if (booking.status === 'Chờ nhận phòng') { %>
            <form action="/customer/cancel-booking" method="POST" class="mt-3">
              <input type="hidden" name="bookingId" value="<%= booking.bookingId %>">
              <button type="submit" class="btn btn-danger"
                      onclick="return confirm('Bạn có chắc muốn hủy đặt phòng này không?')">
                <i class="fa-solid fa-ban me-1"></i> Hủy đặt phòng
              </button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  <!-- Thông tin hóa đơn -->
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="fw-bold mb-3">Thông tin hóa đơn</h5>
    <% if (inv) { %>
    <p><strong>Mã hóa đơn:</strong> #<%= inv.invoiceId %></p>
    <p>
      <strong>Ngày tạo:</strong> <%= new
      Date(inv.invoiceDate).toLocaleDateString('vi-VN') %>
    </p>
    <p><strong>Số tiền:</strong> <%= inv.amount.toLocaleString() %> VND</p>
    <p>
      <strong>Trạng thái:</strong> <% if (inv.status === 'Đã thanh toán') { %>
      <span class="text-success fw-bold"><%= inv.status %></span> <% } else { %>
      <span class="text-warning"><%= inv.status %></span> <% } %>
    </p>
    <% } else { %>
    <p class="text-muted">Chưa có hóa đơn cho đơn đặt phòng này.</p>
    <% } %>
  </div>
  <!-- ✅ Form đánh giá: dùng tích chọn sao -->
  <% if (booking.invoice && booking.invoice.status === 'Đã thanh toán') { %>
  <div class="card shadow-sm p-4 mt-4">
    <h5 class="fw-bold mb-3">Đánh giá phòng</h5>
    <form
      action="/customer/review/<%= booking.bookingId %>"
      method="POST"
      class="needs-validation"
      novalidate
    >
      <div class="mb-3">
        <label class="form-label d-block mb-2">Mức đánh giá:</label>
        <div class="rating-stars">
          <% for (let i = 5; i >= 1; i--) { %>
          <input
            type="radio"
            id="star<%= i %>"
            name="rating"
            value="<%= i %>"
            required
          />
          <label for="star<%= i %>" title="<%= i %> sao">★</label> <% } %>
        </div>
        <div class="invalid-feedback">Vui lòng chọn mức đánh giá.</div>
      </div>
      <div class="mb-3">
        <label for="comment" class="form-label">Nhận xét của bạn:</label>
        <textarea
          class="form-control"
          id="comment"
          name="comment"
          rows="4"
          placeholder="(Không bắt buộc) Bạn có thể chia sẻ thêm cảm nhận..."
        ></textarea>
        <div class="invalid-feedback">Nhận xét phải có ít nhất 5 ký tự.</div>
      </div>
      <button type="submit" class="btn btn-primary px-4">Gửi đánh giá</button>
    </form>
  </div>
  <!-- Gắn file CSS & JS riêng -->
  <link rel="stylesheet" href="/css/review-stars.css" />
  <script src="/javascript/review-stars.js"></script>
  <% } %> <% } %>
</div>
<%- include('../partials/footer') %>
